{% extends 'layout.html' %}
{% block content %}
<h1>User Posts</h1>

<form method="GET" class="search-sort-form">
    <input 
        type="text" 
        name="q" 
        placeholder="Search by title or content"
        value="{{ request.args.get('q', '') }}"
    >

    <select name="sort">
        <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>Newest</option>
        <option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>Oldest</option>
        <option value="title" {% if request.args.get('sort') == 'title' %}selected{% endif %}>Title (A-Z)</option>
    </select>

    <select name="typeFilter">
        <option value="">All Types</option>
        <option value="post" {% if request.args.get('typeFilter') == 'post' %}selected{% endif %}>Posts</option>
        <option value="recipe" {% if request.args.get('typeFilter') == 'recipe' %}selected{% endif %}>Recipes</option>
        <option value="produce" {% if request.args.get('typeFilter') == 'produce' %}selected{% endif %}>Produce</option>
    </select>
    {% if userID %}
    <label style="display: flex; align-items: center; gap: 5px;">
        <input type="checkbox" name="starredOnly" value="1" {% if request.args.get('starredOnly') %}checked{% endif %}>
        ‚≠ê Starred
    </label>
    {% endif %}
    <button type="submit">Apply</button>
</form>

<div class="posts-wrapper">
    <div class="post-summaries">
        {% for post in posts %}
        <div 
            class="post-summary"
            onclick="window.location='{{ url_for('posts', postID=post.postID, 
    q=request.args.get('q', ''), 
    sort=request.args.get('sort', 'newest'), 
    typeFilter=request.args.get('typeFilter', ''), 
    starredOnly=request.args.get('starredOnly', '') ) }}'"
        >
            <div class="summary-title">{{ post.title }}</div>
            <div class="summary-user">By {{ post.username }}</div>
            <div class="summary-snippet">{{ post.content[:100] }}...</div>
        </div>
        {% else %}
        <p>No posts found.</p>
        {% endfor %}
    </div>

    <div class="post-detail">
        {% if selectedPost %}
            <h2>{{ selectedPost.title }}</h2>
            <p><em>By {{ selectedPost.username }}</em></p>
            {% if selectedPost.image and selectedPost.image != "None" %}
                <img src="{{ selectedPost.image }}" 
                 onerror="this.onerror=null; this.src='/static/uploads/123/imageError.png';"
                 class="detail-image">
            {% endif %}
            <p>{{ selectedPost.content }}</p>
            {% if userID %}
            <div class="vote-buttons">
                {% set votes = {
                    'upVote': 'üëç',
                    'downVote': 'üëé',
                    'funnyVote': 'üòÇ',
                    'loveVote': '‚ù§Ô∏è',
                    'ideaVote': 'üí°',
                    'star': '‚≠ê',
                } %}

                {% for voteType, icon in votes.items() %}
                <form method="POST" action="{{ url_for('posts', **request.args.to_dict()) }}">
                    <input type="hidden" name="postID" value="{{ selectedPost.postID }}">
                    <input type="hidden" name="voteType" value="{{ voteType }}">
                    <input type="hidden" name="action" value="vote">

                    {% set voteList = (selectedPost[voteType] or '').split('-') if selectedPost[voteType] else [] %}
                    {% set hasVoted = userID|string in (selectedPost[voteType] or '') %}

                    <button 
                        type="submit" 
                        class="vote-btn {% if hasVoted %}voted{% else %}not-voted{% endif %}"
                        title="{{ voteType }}"
                    >
                        {{ icon }} {{ voteList|length }}
                    </button>
                </form>
                {% endfor %}
            </div>
            {% else %}
            <br>
            <p>Please log in to like and favourite posts.</p>
                {% endif %}
            <div class="replies">
                {% if replies %}
                    {% for reply in replies %}
                        <div class="reply-card">
                            <b>{{ reply.username }}</b> ‚Ä¢ <small>{{ reply.time }}</small>
                            <p id="bordered">{{ reply.content }}</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No replies yet.</p>
                {% endif %}
            </div>

            {% if userID %}
                <form 
                    method="POST" 
                    action="{{ url_for('posts', postID=selectedPost.postID, q=request.args.get('q', ''), sort=request.args.get('sort', 'newest')) }}" 
                    class="reply-form"
                >
                    <input type="hidden" name="action" value="reply" />
                    <input type="hidden" name="postID" value="{{ selectedPost.postID }}" />
                    <textarea name="reply" placeholder="Write a reply..." required maxlength="255"></textarea>
                    <br><button type="submit">Reply</button><br>
                </form>
            {% else %}
                <p class="login-prompt">Please log in to reply.</p>
            {% endif %}
        {% else %}
            <p>Select a post to view details.</p>
        {% endif %}
    </div>
</div>

{% if userID %}
<button class="create-post-btn" onclick="toggleCreatePost()">+</button>
{% endif %}

<div class="create-post-panel" id="createPostPanel">
    <div class="create-post-content">
        <h2>Create New Post</h2>
        <form method="POST" enctype="multipart/form-data" action="{{ url_for('posts') }}">
            <input type="hidden" name="action" value="new_post">

            <label>Title</label>
            <input type="text" name="title" required>

            <label>Content</label>
            <br>
            <textarea name="content" required></textarea>
            <br>
            <label>Post Type</label>
            <select id="typeSelect" name="type" required>
                <option value="">Select post type</option>
                <option value="post">Post</option>
                <option value="recipe">Recipe</option>
                <option value="produce">Produce</option>
            </select>

            <label>Image</label>
            <div id="drop-area">
                <p id="drop-text">Drag & drop an image, or click to select.</p>
                <input type="file" name="image_file" id="fileElem" accept="image/*">
                <div id="image-preview"></div>
                <button type="button" id="remove-image-btn" class="remove-btn" style="display:none;">Remove Image</button>
            </div>
            <br>
            <div id="flash-message">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            
            <div class="form-buttons">
                <button type="submit" class="submit-btn">Post</button>
                <button type="button" class="cancel-btn" onclick="toggleCreatePost()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function toggleCreatePost() {
    document.getElementById('createPostPanel').classList.toggle('active');
}
</script>

<style>
    
 .vote-buttons {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    background-color: #d1ffbd;
    border-radius: 10px;
    padding: 10px;
}

.vote-btn {
    width: 100%;
    height: 55px;
    font-size: 1.1em;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.25s ease, transform 0.1s ease, box-shadow 0.25s ease;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
}

.vote-btn.not-voted {
    background-color: #bdf5b2;
    color: #2e6d2e;
}

.vote-btn.voted {
    background-color: #4CAF50;
    color: white;
}

.vote-btn.not-voted:hover {
    background-color: #7de96a; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.vote-btn.voted:hover {
    background-color: #67d46f; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.vote-btn:hover {
    transform: scale(1.03);
}

    .create-post-content select {
    width: 100%;
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #b5e6a2;
    background-color: #f9fff4;
    font-size: 1em;
    color: #333;
    cursor: pointer;
    transition: background-color 0.2s;
}

.create-post-content select:hover {
    background-color: #e8ffe1;
}
   #drop-area {
    border: 2px dashed #4CAF50;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    background-color: #e8ffe1;
}
#drop-area.highlight {
    background-color: #d1ffbd;
}
#drop-area input[type=file] {
    display: none;
}

.posts-wrapper {
    display: grid;
    grid-template-columns: 30% 70%;
    gap: 20px;
    height: 80vh;
}

.search-sort-form {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 12px;
    background-color: #eaffda;
    padding: 10px 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-sort-form input[type="text"] {
    flex: 2;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #bbb;
    font-size: 1em;
}

.search-sort-form select,
.search-sort-form button {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #bbb;
    background-color: #d1ffbd;
    cursor: pointer;
    transition: background-color 0.2s;
}

.search-sort-form button:hover {
    background-color: #b8f69f;
}

.post-summaries {
    overflow-y: auto;
    background-color: #f9fff4;
    border-right: 3px solid #b5e6a2;
    padding: 15px;
    border-radius: 10px;
}

.post-summary {
    border: 1px solid #ccc;
    border-radius: 10px;
    background-color: #d1ffbd;
    margin-bottom: 12px;
    padding: 12px;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
}

.post-summary:hover {
    background-color: #c2ff9a;
    transform: scale(1.01);
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
}

.summary-title {
    font-weight: bold;
    font-size: 1.1em;
}

.summary-user {
    font-style: italic;
    color: #555;
    font-size: 0.9em;
    margin-bottom: 4px;
}

.summary-snippet {
    font-size: 0.9em;
    color: #333;
}

.post-detail {
    background: #e8ffe1;
    border-radius: 12px;
    padding: 20px;
    overflow-y: auto;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.08);
}
.detail-image {
    max-width: 100%;
    border-radius: 10px;
    margin: 10px 0;
}
.replies {
    margin-top: 15px;
    border-top: 1px solid #b5e6a2;
    padding-top: 10px;
}
.reply-card {
    background: #d1ffbd;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 8px;
}

.reply-form textarea {
    width: 100%;
    max-width: 100%;
    height: 80px;
    margin-top: 10px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #b5e6a2;
    font-family: inherit;
}
.reply-form button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
}
.reply-form button:hover {
    background-color: #3e8e41;
}

.create-post-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 28px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: background 0.2s, transform 0.2s;
    z-index: 100;
}
.create-post-btn:hover {
    background: #3e8e41;
    transform: scale(1.05);
}

.create-post-panel {
    position: fixed;
    top: 0;
    right: -500px;
    width: 480px;
    height: 100%;
    background: #d1ffbd;
    box-shadow: -2px 0 12px rgba(0,0,0,0.2);
    border-left: 3px solid #b5e6a2;
    transition: right 0.3s ease;
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
}
.create-post-panel.active {
    right: 0;
}
.create-post-content h2 {
    margin-top: 0;
}
.create-post-content input,
.create-post-content textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #b5e6a2;
}
.form-buttons {
    display: flex;
    justify-content: space-between;
}
.submit-btn {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
.submit-btn:hover {
    background-color: #3e8e41;
}
.cancel-btn {
    background: #f44336;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
.remove-btn {
    background: #ffa500;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}

#bordered {
    max-width: 600px;
    overflow-wrap: break-word;
}
</style>


{% endblock %}
